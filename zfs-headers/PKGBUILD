
_extramodules=6.2.11-1
_kver="$(cat /lib/modules/extramodules-6.2/version)"

pkgname=zfs-headers
pkgver=2.1.9
pkgrel=3
pkgdesc="Kernel headers for the Zettabyte File System."
arch=('x86_64')
url="https://zfsonlinux.org/"
license=('CDDL')
depends=('kmod' 'linux' "zfs=${pkgver}")
makedepends=('linux-headers' 'elfutils')
source=("https://github.com/zfsonlinux/zfs/releases/download/zfs-${pkgver}/zfs-${pkgver}.tar.gz"
        "https://github.com/openzfs/zfs/commit/3ace9dea01f2088e81c0b90ca8e07faad7364eca.diff"
        "https://github.com/openzfs/zfs/commit/2e9c9b792fd34b4fe1fb524444529f41bcb1b7c5.diff")
sha256sums=('6b172cdf2eb54e17fcd68f900fab33c1430c5c59848fa46fab83614922fe50f6'
            '1c1322194bbaee4c13186033b9b25eed1440b1f076faf735e45aa7a30fd6dd87'
            '41e05c2f20e630c8f943af253fa73024b1cb8e222c7caf3ed5883d58ca2cc31e')

build() {
    cd zfs-${pkgver}
    patch -p1 -i ${srcdir}/3ace9dea01f2088e81c0b90ca8e07faad7364eca.diff
    patch -p1 -i ${srcdir}/2e9c9b792fd34b4fe1fb524444529f41bcb1b7c5.diff

    ./autogen.sh
    ./configure --prefix=/usr \
        --sysconfdir=/etc \
        --datadir=/usr/share \
        --libdir=/lib \
        --includedir=/usr/include \
        --with-udevdir=/usr/lib/udev \
        --libexecdir=/usr/lib \
        --with-config=kernel \
        --with-linux=/lib/modules/${_extramodules}/build \
        --with-linux-obj=/lib/modules/${_extramodules}/build
    make
}

package() {
    cd zfs-${pkgver}

    make DESTDIR=${pkgdir} install
    #remove references to the buildsystem
    sed -i "s|${srcdir}||" ${pkgdir}/usr/src/zfs-*/${_extramodules}/Module.symvers
    #remove modules
    rm -r ${pkgdir}/lib
    #remove kernel specific headers
    rm -r ${pkgdir}/usr/src/zfs-${pkgver}/${_extramodules}
    rm -r ${pkgdir}/usr/src/spl-${pkgver}/${_extramodules}

    install -D -m0644 LICENSE -t ${pkgdir}/usr/share/licenses/${pkgname}
}
